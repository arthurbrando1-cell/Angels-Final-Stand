<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamedevspace | Natal Edition üéÑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
    :root {
        --primary: #ff2e40; --primary-glow: rgba(255, 46, 64, 0.5);
        --secondary: #00ff9c; --gold: #ffd700; --bg-dark: #020205;
        --bg-card: rgba(20, 20, 25, 0.7); --glass: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.15); --text-main: #ffffff;
        --text-muted: #b0b0bb; --radius: 16px; --ease: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0; font-family: 'Outfit', sans-serif; color: var(--text-main); background-color: var(--bg-dark);
        background-image: radial-gradient(circle at 10% 10%, rgba(255, 46, 64, 0.15), transparent 30%), radial-gradient(circle at 90% 90%, rgba(0, 255, 156, 0.08), transparent 30%);
        min-height: 100vh; overflow-x: hidden;
    }

    /* LOADING SCREEN */
    #loading { position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; transition: 0.5s; }
    .loader { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: rot 1s linear infinite; }
    @keyframes rot { 100% { transform: rotate(360deg); } }

    /* HEADER & UI */
    header { display: flex; justify-content: space-between; align-items: center; padding: 0 5%; height: 80px; background: rgba(2, 2, 5, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
    .brand { font-weight: 900; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
    .brand span { color: var(--primary); }
    .nav-actions { display: flex; gap: 12px; align-items: center; }
    
    .btn-primary { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 99px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--primary-glow); }

    .user-pill { display: flex; align-items: center; gap: 10px; padding: 5px 15px 5px 5px; background: var(--glass); border: 1px solid var(--border); border-radius: 99px; cursor: pointer; }
    .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #222; }

    /* GRID */
    .main-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 40px 5%; }
    .game-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; transition: 0.3s; cursor: pointer; position: relative; }
    .game-card:hover { transform: translateY(-5px); border-color: var(--primary); }
    .card-img { width: 100%; height: 180px; object-fit: cover; }
    .card-body { padding: 15px; }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; place-items: center; padding: 20px; overflow-y: auto; }
    .modal-box { background: #111; border: 1px solid var(--border); width: 100%; max-width: 450px; padding: 30px; border-radius: 24px; }
    .form-input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); border-radius: 10px; color: #fff; margin-bottom: 15px; font-family: inherit; }
    
    .upload-area { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: 0.3s; }
    .upload-area:hover { border-color: var(--secondary); background: rgba(0,255,156,0.05); }
    input[type="file"] { display: none; }

    .profile-banner { width: 100%; height: 100px; border-radius: 12px; object-fit: cover; background: #222; margin-bottom: 10px; border: 1px solid var(--border); }

    /* PLAYER */
    .game-player { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
    .player-header { height: 60px; background: #111; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
    iframe { flex: 1; border: none; width: 100%; height: 100%; }

    #snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
    .snowflake { position: absolute; top: -10px; color: #fff; animation: fall linear forwards; }
</style>
</head>
<body>

<div id="loading"><div class="loader"></div><p>Sincronizando com o Papai Noel...</p></div>
<div id="snow-container"></div>
<div id="toast-container"></div>

<header>
    <div class="brand"><i data-lucide="gift"></i> Gamedevspace<span>.Cloud</span></div>
    <div class="nav-actions">
        <button class="btn-primary" onclick="openModal('postModal')"><i data-lucide="plus"></i> POSTAR</button>
        <div class="user-pill" onclick="openModal('profileModal')">
            <img id="userAvatar" class="avatar" src="https://ui-avatars.com/api/?name=Guest">
            <span id="navUserName">Entrar</span>
        </div>
    </div>
</header>

<div class="main-grid" id="gameGrid"></div>

<div class="modal-overlay" id="postModal" onclick="closeOnOverlay(event, this)">
    <div class="modal-box">
        <h2 style="margin-top:0">üéÅ Publicar Jogo</h2>
        <input id="gTitle" class="form-input" placeholder="Nome do Jogo">
        
        <label class="upload-area" for="fileGame">
            <i data-lucide="file-code"></i><br>Subir HTML/JS (Base64)
            <input type="file" id="fileGame" accept=".html,.js" onchange="handleFileUpload(this, 'gUrl')">
        </label>
        <input id="gUrl" class="form-input" placeholder="Ou cole a URL do Iframe">

        <label class="upload-area" for="fileThumb">
            <i data-lucide="image"></i><br>Subir Capa do Jogo
            <input type="file" id="fileThumb" accept="image/*" onchange="handleFileUpload(this, 'gImg')">
        </label>
        <input id="gImg" class="form-input" placeholder="Ou cole URL da imagem">

        <select id="gCat" class="form-input">
            <option>Natal üéÑ</option><option>A√ß√£o</option><option>RPG</option><option>Terror</option>
        </select>
        <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveGame()">PUBLICAR</button>
    </div>
</div>

<div class="modal-overlay" id="profileModal" onclick="closeOnOverlay(event, this)">
    <div class="modal-box">
        <div id="authSection">
            <h2>üéÖ Acesso</h2>
            <input id="loginNick" class="form-input" placeholder="Seu Nickname">
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="login()">ENTRAR</button>
        </div>
        <div id="userSection" style="display:none">
            <img id="pBannerPreview" class="profile-banner" src="">
            <h2 id="pNickTitle" style="margin: 0 0 15px 0">Nick</h2>
            
            <p style="font-size:0.8rem; color:var(--text-muted)">Foto de Perfil (URL ou Upload):</p>
            <input id="pAvatarInput" class="form-input" placeholder="URL da Foto/GIF">
            <input type="file" id="fAvatar" accept="image/*" onchange="handleFileUpload(this, 'pAvatarInput')">
            <button class="btn-primary" style="margin-bottom:10px; font-size:0.8rem" onclick="document.getElementById('fAvatar').click()">Upload Foto</button>

            <p style="font-size:0.8rem; color:var(--text-muted)">Banner (URL ou Upload):</p>
            <input id="pBannerInput" class="form-input" placeholder="URL do Banner/GIF">
            <input type="file" id="fBanner" accept="image/*" onchange="handleFileUpload(this, 'pBannerInput')">
            <button class="btn-primary" style="margin-bottom:20px; font-size:0.8rem" onclick="document.getElementById('fBanner').click()">Upload Banner</button>

            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveProfile()">SALVAR ALTERA√á√ïES</button>
            <button onclick="logout()" style="background:none; border:none; color:red; cursor:pointer; margin-top:15px; width:100%">Sair da conta</button>
        </div>
    </div>
</div>

<div class="game-player" id="gamePlayer">
    <div class="player-header">
        <button onclick="closePlayer()" style="background:none; border:none; color:#fff; cursor:pointer"><i data-lucide="x"></i></button>
        <span id="playingTitle">Jogo</span>
        <div style="width:24px"></div>
    </div>
    <iframe id="gameFrame"></iframe>
</div>

<script>
// --- CONFIGURA√á√ÉO FIREBASE ---
const firebaseConfig = { 
    apiKey: "SUA_API_KEY_AQUI", 
    authDomain: "gamehub-b8338.firebaseapp.com", 
    projectId: "gamehub-b8338" 
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem("gs_user")) || null;

// --- INICIALIZA√á√ÉO ---
window.onload = () => {
    lucide.createIcons();
    updateUI();
    loadGames();
    startSnow();
    
    // REMOVE O LOADING MESMO SE O FIREBASE TRAVAR
    setTimeout(() => {
        document.getElementById('loading').style.opacity = '0';
        setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
    }, 1500);
};

// --- FUN√á√ïES DE ARQUIVO (BASE64) ---
function handleFileUpload(input, targetId) {
    const file = input.files[0];
    if(!file) return;
    if(file.size > 1048487) return alert("Arquivo muito grande! M√°ximo 1MB.");

    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById(targetId).value = e.target.result;
        if(targetId === 'pBannerInput') document.getElementById('pBannerPreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// --- AUTH & PERFIL ---
function login() {
    const nick = loginNick.value.trim();
    if(!nick) return;
    
    // Busca dados no Firestore
    db.collection("users").doc(nick).get().then(doc => {
        if(doc.exists) {
            currentUser = doc.data();
        } else {
            currentUser = { nick, avatar: "", banner: "", role: "user" };
        }
        localStorage.setItem("gs_user", JSON.stringify(currentUser));
        updateUI();
        closeModals();
    });
}

function saveProfile() {
    currentUser.avatar = pAvatarInput.value;
    currentUser.banner = pBannerInput.value;
    
    db.collection("users").doc(currentUser.nick).set(currentUser).then(() => {
        localStorage.setItem("gs_user", JSON.stringify(currentUser));
        updateUI();
        alert("Perfil salvo!");
        closeModals();
    });
}

function logout() {
    localStorage.removeItem("gs_user");
    currentUser = null;
    location.reload();
}

function updateUI() {
    if(currentUser) {
        navUserName.innerText = currentUser.nick;
        userAvatar.src = currentUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.nick}`;
        authSection.style.display = 'none';
        userSection.style.display = 'block';
        pNickTitle.innerText = currentUser.nick;
        pAvatarInput.value = currentUser.avatar;
        pBannerInput.value = currentUser.banner;
        pBannerPreview.src = currentUser.banner;
    }
}

// --- JOGOS ---
function saveGame() {
    if(!currentUser) return alert("Fa√ßa login primeiro!");
    const game = {
        title: gTitle.value,
        url: gUrl.value,
        img: gImg.value,
        category: gCat.value,
        author: currentUser.nick,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("games").add(game).then(() => {
        alert("Jogo postado!");
        closeModals();
    }).catch(e => alert("Erro ao postar. Verifique se o arquivo n√£o √© muito grande."));
}

function loadGames() {
    db.collection("games").orderBy("createdAt", "desc").onSnapshot(snap => {
        gameGrid.innerHTML = "";
        snap.forEach(doc => {
            const g = doc.data();
            const card = document.createElement('div');
            card.className = "game-card";
            card.onclick = () => openPlayer(g.url, g.title);
            card.innerHTML = `
                <img class="card-img" src="${g.img || 'https://placehold.co/400x200?text=Sem+Capa'}">
                <div class="card-body">
                    <div style="font-weight:700">${g.title}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${g.category}</div>
                </div>
            `;
            gameGrid.appendChild(card);
        });
    });
}

// --- PLAYER ---
function openPlayer(url, title) {
    gamePlayer.style.display = 'flex';
    gameFrame.src = url;
    playingTitle.innerText = title;
}
function closePlayer() {
    gamePlayer.style.display = 'none';
    gameFrame.src = "";
}

// --- UTILS ---
function openModal(id) { document.getElementById(id).style.display = 'grid'; }
function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
function closeOnOverlay(e, el) { if(e.target === el) closeModals(); }

function startSnow() {
    const container = document.getElementById('snow-container');
    setInterval(() => {
        const flake = document.createElement('div');
        flake.className = "snowflake";
        flake.innerText = "‚ùÑ";
        flake.style.left = Math.random() * 100 + "vw";
        flake.style.animationDuration = (Math.random() * 3 + 2) + "s";
        container.appendChild(flake);
        setTimeout(() => flake.remove(), 5000);
    }, 200);
}
</script>
</body>
</html>
